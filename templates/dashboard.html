<!-- Add these sections to your existing dashboard.html -->

<!-- Add this after the existing filter section -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-exclamation-triangle text-warning"></i> Urgent Alerts</h6>
            </div>
            <div class="card-body">
                <div id="alertsContainer">
                    <div class="text-center">
                        <button class="btn btn-sm btn-warning" onclick="loadAlerts()">
                            Check Urgent Leads
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-pie text-info"></i> Market Analysis</h6>
            </div>
            <div class="card-body">
                <div id="marketAnalysis">
                    <div class="text-center">
                        <button class="btn btn-sm btn-info" onclick="loadMarketAnalysis()">
                            View Market Trends
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-building text-success"></i> Company Sizes</h6>
            </div>
            <div class="card-body">
                <div id="companySizeAnalysis">
                    <div class="text-center">
                        <button class="btn btn-sm btn-success" onclick="loadCompanySizeAnalysis()">
                            Analyze Companies
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal for contact suggestions -->
<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sales Strategy & Contacts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contactSuggestions"></div>
        </div>
    </div>
</div>

<!-- Add these JavaScript functions to your existing script section -->
<script>
// Add these functions to your existing JavaScript

async function loadAlerts() {
    try {
        const response = await fetch('/api/alerts');
        const alerts = await response.json();
        
        const container = document.getElementById('alertsContainer');
        
        if (response.ok && alerts.length > 0) {
            container.innerHTML = alerts.map(alert => `
                <div class="alert alert-warning alert-sm p-2 mb-2">
                    <small><strong>${alert.company}</strong><br>
                    ${alert.message}<br>
                    <em>Action: ${alert.action}</em></small>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<small class="text-muted">No urgent alerts</small>';
        }
    } catch (error) {
        console.error('Error loading alerts:', error);
    }
}

async function loadMarketAnalysis() {
    try {
        const response = await fetch('/api/market-analysis');
        const analysis = await response.json();
        
        const container = document.getElementById('marketAnalysis');
        
        if (response.ok && analysis.length > 0) {
            container.innerHTML = analysis.slice(0, 3).map(area => `
                <div class="mb-2">
                    <small><strong>${area.therapeutic_area}</strong><br>
                    ${area.trial_count} trials, ${area.company_count} companies<br>
                    <span class="badge badge-sm bg-${area.market_opportunity === 'High' ? 'success' : 'warning'}">${area.market_opportunity}</span></small>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<small class="text-muted">No data available</small>';
        }
    } catch (error) {
        console.error('Error loading market analysis:', error);
    }
}

async function loadCompanySizeAnalysis() {
    try {
        const response = await fetch('/api/company-size-analysis');
        const analysis = await response.json();
        
        const container = document.getElementById('companySizeAnalysis');
        
        if (response.ok) {
            container.innerHTML = `
                <small>
                    <strong>Large Pharma:</strong> ${analysis.summary.large_pharma_count}<br>
                    <strong>Mid-size:</strong> ${analysis.summary.mid_size_count}<br>
                    <strong>Small Biotech:</strong> ${analysis.summary.small_biotech_count}<br>
                    <strong>Total:</strong> ${analysis.summary.total_companies}
                </small>
            `;
        } else {
            container.innerHTML = '<small class="text-muted">No data available</small>';
        }
    } catch (error) {
        console.error('Error loading company analysis:', error);
    }
}

async function viewContactSuggestions(companyName) {
    try {
        const response = await fetch(`/api/contact-suggestions/${encodeURIComponent(companyName)}`);
        const data = await response.json();
        
        if (response.ok) {
            displayContactSuggestions(data);
        } else {
            alert('Error loading contact suggestions: ' + data.error);
        }
    } catch (error) {
        alert('Error loading contact suggestions: ' + error.message);
    }
}

function displayContactSuggestions(data) {
    const modal = document.getElementById('contactModal');
    const container = document.getElementById('contactSuggestions');
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Company Profile</h6>
                <p><strong>Size:</strong> ${data.profile.size}</p>
                <p><strong>Priority:</strong> <span class="badge bg-${data.profile.priority === 'High' ? 'danger' : 'warning'}">${data.profile.priority}</span></p>
                <p><strong>Urgency:</strong> ${data.profile.urgency}</p>
                
                <h6>Key Contacts</h6>
                ${data.key_contacts.map(contact => `
                    <div class="mb-2">
                        <strong>${contact.role}</strong> <span class="badge bg-${contact.priority === 'High' ? 'danger' : 'warning'}">${contact.priority}</span><br>
                        <small class="text-muted">${contact.message}</small>
                    </div>
                `).join('')}
            </div>
            
            <div class="col-md-6">
                <h6>Outreach Strategy</h6>
                <p><strong>Timing:</strong> ${data.outreach_strategy.timing}</p>
                <p><strong>Value Prop:</strong> ${data.outreach_strategy.value_proposition}</p>
                
                <h6>Pain Points to Address</h6>
                <ul class="list-unstyled">
                    ${data.outreach_strategy.pain_points.map(point => `<li>• ${point}</li>`).join('')}
                </ul>
                
                <h6>Talking Points</h6>
                <ul class="list-unstyled">
                    ${data.talking_points.map(point => `<li>• ${point}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(modal).show();
}

// Update the existing createLeadCard function to include contact suggestions button
function createLeadCard(lead) {
    const col = document.createElement('div');
    col.className = 'col-md-6 mb-3';
    
    const companies = lead.companies.map(company => 
        `<span class="company-tag">${company}</span>`
    ).join('');
    
    col.innerHTML = `
        <div class="card lead-card priority-${lead.priority.toLowerCase()}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <h6 class="card-title">${lead.drug_name || 'Unknown Drug'}</h6>
                    <span class="badge bg-${lead.priority === 'High' ? 'danger' : lead.priority === 'Medium' ? 'warning' : 'success'}">
                        ${lead.priority}
                    </span>
                </div>
                <div class="mb-2">${companies}</div>
                <p class="card-text small text-muted">${lead.condition || 'Condition not specified'}</p>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Phase:</small><br>
                        <strong>${lead.phase || 'Unknown'}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">FDA Likelihood:</small><br>
                        <span class="likelihood-score text-primary">${lead.fda_likelihood}%</span>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Status: ${lead.status}</small><br>
                    <small class="text-muted">Completion: ${lead.completion_date || 'TBD'}</small>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewCompanyDetails('${lead.companies[0]}')">
                        <i class="fas fa-eye"></i> Pipeline
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="viewContactSuggestions('${lead.companies[0]}')">
                        <i class="fas fa-phone"></i> Contacts
                    </button>
                    <a href="https://clinicaltrials.gov/ct2/show/${lead.nct_id}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i> Source
                    </a>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// Auto-load enhanced features when page loads
window.addEventListener('load', function() {
    loadLeads();
    setTimeout(() => {
        loadAlerts();
        loadMarketAnalysis();
        loadCompanySizeAnalysis();
    }, 2000); // Load after main data
});
</script>